/**

\page TutorialHydroAMR Scattering from dust in a Kelvin-Helmholtz instability with SKIRT

\image html TutorialHydroAMR.png

<i>Illustration above</i>: surface brightness of scattered radiation for the AMR-simulated Kelvin-Helmholtz instability
used in this tutorial.

In this tutorial you will use <tt>SKIRT</tt> to study the dust in a Kelvin-Helmholtz instability as it might occur in a
molecular cloud. The dust distribution has been generated by a hydrodynamical simulation on an adaptive mesh (AMR =
Adaptive Mesh Refinement) with the MPI-AMRVAC code developed at the K.U.Leuven (see <a
href="http://homes.esat.kuleuven.be/~keppens">http://homes.esat.kuleuven.be/~keppens</a>). The simulation includes a
gas component and two dust components with different characteristics. The simulation results are stored as a single
data file in a binary format specific to MPI-AMRVAC. In addition to a more generic AMR import format using text
columns, <tt>SKIRT</tt> can also directly import the MPI-AMRVAC binary format.

The <a href="../skirt8/_concepts.html">SKIRT concepts section</a> includes a concept note that provides a more general
overview of <tt>SKIRT</tt>'s capabilities for postprocessing (magneto-)hydrodynamical simulation results.

\section TutorialHydroAmrPre Getting ready

This tutorial assumes that you have completed the introductory <tt>SKIRT</tt> tutorial titled "Monochromatic simulation
of a dusty disk galaxy", or that you have otherwise acquired the working knowlegde introduced there. At the very least,
before starting this tutorial, you should have installed the <tt>SKIRT</tt> code, some means to plot column text files
(preferably <tt>PTS</tt>), and a FITS file viewer (preferably DS9).

To complete this tutorial, you need an example output file produced by the MPI-AMRVAC simulation. Download the file \c
kh_amr.dat from the <a href="../version8/_downloads.html">SKIRT downloads page</a> and put it into your local working
directory.

\section TutorialHydroAmrSki Creating the ski file

In a Terminal window, with an appropriate current directory, start <tt>SKIRT</tt> without any command line arguments.
SKIRT responds with a welcome message and starts an interactive session in the terminal window, during which it
will prompt you for all the information describing a particular simulation:

\verbatim
   Welcome to SKIRT v___
   Interactively constructing a simulation...
 ? Enter the name of the ski file to be created: ScatAMR
\endverbatim

The first question is for the filename of the \em ski file. For this tutorial, enter "ScatAMR".

\section TutorialHydroAmrSim Type of simulation

\verbatim
   Possible choices for a Monte Carlo simulation:
      1. An oligochromatic Monte Carlo simulation
      2. A panchromatic Monte Carlo simulation
 ? Enter one of these numbers [1,2] (1): 1
   ...
\endverbatim

In an actual research setting you would probably run a panchromatic simulation to study the absorption, scattering and
thermal emission by the dust over a range of wavelengths. In this tutorial you will simply study scattering by the dust
at three specific optical wavelengths. An oligochromatic simulation is sufficient and most performance-effective for
this purpose.

Leave the seed for the random generator to its default value (not shown).

\section TutorialHydroAmrUni Units

\verbatim
   Possible choices for the units system:
      1. SI units
      2. Stellar units (length in AU, distance in pc)
      3. Extragalactic units (length in pc, distance in Mpc)
 ? Enter one of these numbers [1,3] (3): 2
   Possible choices for the output style for flux density and surface brightness:
      1. Neutral: lambda F_lambda = nu F_nu
      2. Wavelength: F_lambda
      3. Frequency: F_nu
 ? Enter one of these numbers [1,3] (1): 3
\endverbatim

The spatial scale of the dust distribution used in this tutorial is such that it is best to select stellar units. While
you can still use any of the supported units to enter parameter values, this means that all output values will be
presented in stellar units. Furthermore, select the frequency output style, expressing integrated fluxes in Jy and
surface densities in MJy/sr.

\section TutorialHydroAmrWave Wavelength grid

\verbatim
   ...
 ? Enter the wavelengths [0.0001 micron,1e6 micron]: 0.3, 0.55, 0.8
\endverbatim

For this tutorial enter a wavelength list containing three values at the extremes and in the center of the optical
wavelength range: \f$\lambda_{1,2,3}=0.3,0.55,0.8\,\mu\textrm{m}\f$. Note that <tt>SKIRT</tt> will automatically
sort the wavelengths from short to long, regardless of the input ordering.

\section TutorialHydroAmrStel Stellar system

\verbatim
   ...
   Possible choices for item #1 in the stellar components list:
      1. A stellar component with a built-in geometry (in an oligochromatic simulation)
      2. A stellar component derived from an SPH output file
      3. A stellar component imported from an adaptive mesh data file
      4. A stellar component imported from a Voronoi mesh data file
 ? Enter one of these numbers [1,4] (1): 1
   Possible choices for the geometry of the spatial stellar distribution:
      1. A point source geometry
      2. A Plummer geometry
      3. A gamma geometry
         ...
 ? Enter one of these numbers [1,46] (1): 2
 ? Enter the scale length ]0 AU,.. AU[: 0.03e18 cm
 ? Enter the luminosities, one for each wavelength ]0 Lsun/micron,.. Lsun/micron[: 1e-6, 1e-6, 1e-6
   Possible choices for item #2 in the stellar components list:
      1. A stellar component with a built-in geometry (in an panchromatic simulation)
         ...
 ? Enter one of these numbers or zero to terminate the list [0,4] (0): 0
\endverbatim

Since the data file provided for this tutorial has no information on radiation sources, you need to provide an
artificial stellar system to illuminate the dust. The suggested option is to use a Plummer profile with a scale length
comparable to the size of the dust distribution; this creates a fairly constant source of light across the
configuration space.

<tt>SKIRT</tt> expects a luminosity value for each of the wavelengths included in the simulation's wavelength grid.
These values can be different depending on the intended spectrum or color of the radiation source. For this tutorial,
specify three identical luminosity values consistent with an artificial background source, for example
\f$L_\lambda = 10^6~\text{L}_\odot/\mu\text{m}\f$.

\section TutorialHydroAmrDust Dust system

\verbatim
   Possible choices for the dust system:
      1. A dust system for use with oligochromatic simulations
 ? Enter one of these numbers or zero to select none [0,1] (1): 1
   Possible choices for the dust distribution:
      1. A dust distribution composed of various dust components
      2. A dust distribution derived from an SPH output file
      3. A dust distribution imported from an adaptive mesh data file
      4. ...
 ? Enter one of these numbers [1,5] (1): 3
 ? Enter the start point of the box in the X direction ]-.. AU,.. AU[: -0.03e18 cm
 ? Enter the end point of the box in the X direction ]-.. AU,.. AU[: 0.03e18 cm
 ? Enter the start point of the box in the Y direction ]-.. AU,.. AU[: -0.03e18 cm
 ? Enter the end point of the box in the Y direction ]-.. AU,.. AU[: 0.03e18 cm
 ? Enter the start point of the box in the Z direction ]-.. AU,.. AU[: -0.03e18 cm
 ? Enter the end point of the box in the Z direction ]-.. AU,.. AU[: 0.03e18 cm
   Possible choices for the adaptive mesh data file:
      1. An adaptive mesh data file in ASCII format
      2. An adaptive mesh data file in MPI-AMRVAC format
 ? Enter one of these numbers [1,2] (1): 2
 ? Enter the name of the adaptive mesh data file: kh_amr.dat
 ? Enter the number of mesh cells at the coarsest level, in the X direction [1,10000]: 32
 ? Enter the number of mesh cells at the coarsest level, in the Y direction [1,10000]: 128
 ? Enter the number of mesh cells at the coarsest level, in the Z direction [1,10000]: 32
 ? Enter the units for the density values ]0 Msun/AU3,.. Msun/AU3[: 1e-21 g/cm3
\endverbatim

For this tutorial, select an oligochromatic dust system (the only applicable type with an oligochromatic simulation)
with a dust distribution imported from an adaptive mesh data file. Select the MPI-AMRVAC format and enter the
appropriate filename (\c kh_amr.dat). You must also provide some information that is not included in the AMR data file:
the number of mesh cells at the coarsest mesh level in each direction; the spatial extent of the mesh in each
direction; and the units of the density values stored in the file.

For the data file used in this tutorial, the number of mesh cells at the coarsest level is \f$32\times128\times32\f$,
the size of the dust distribution is \f$(2\times 0.03\times 10^{18} \mathrm{cm})^3\f$, and the density values in the
file are given in units of \f$10^{-21}\,\mathrm{g}\,\mathrm{cm^{-3}}\f$. Since <tt>SKIRT</tt> understands these units,
there is no need for manual conversion.

Now you need to configure the dust components for which the data file defines a density distribution:

\verbatim
   Possible choices for item #1 in the dust components list:
      1. An mesh dust component
   Automatically selected the only choice: 1
 ? Enter the column defining the density distribution [0,99] (0): 5
 ? Enter the column defining an extra multiplication factor, or -1 [-1,99] (-1):
 ? Enter the fraction of the density actually locked up in dust grains ]0,1] (1):
   Possible choices for the dust mixture for the dust component:
      1. A dust mix with average interstellar properties
      2. A Draine & Li (2007) dust mix
         ...
 ? Enter one of these numbers [1,16] (1):
 ? Output a data file with the optical properties of the dust mix? [yes/no] (yes): no
 ? Output a data file with the mean optical properties of the dust mix? [yes/no] (yes): no

   Possible choices for item #2 in the dust components list:
      1. An mesh dust component
 ? Enter one of these numbers or zero to terminate the list [0,1] (1): 1
 ? Enter the column defining the density distribution [0,99] (0): 6
 ? Enter the column defining an extra multiplication factor, or -1 [-1,99] (-1):
 ? Enter the fraction of the density actually locked up in dust grains ]0,1] (1):
   Possible choices for the dust mixture for the dust component:
      1. A dust mix with average interstellar properties
      2. A Draine & Li (2007) dust mix
      ...
 ? Enter one of these numbers [1,16] (1):
 ? Output the optical properties of the dust mix? [yes/no] (yes): no
 ? Output the mean optical properties of the dust mix? [yes/no] (yes): no

   Possible choices for item #3 in the dust components list:
      1. An mesh dust component
 ? Enter one of these numbers or zero to terminate the list [0,1] (1): 0
\endverbatim

The data file contains two dust density distributions given respectively by the variables (or columns) with indices 5
and 6. There is no extra multiplication factor or fraction, so you can leave these parameters to their default value.
Also, for this tutorial, simply select the default dust mix for each component. In an actual research setting, you
would probably configure a specific dust properties for each of the dust components in the data file.

\verbatim
   Possible choices for the dust grid:
      1. A cartesian dust grid
      2. A 3D dust grid with a two-phase medium
      3. An octtree dust grid
      4. A k-d tree (binary tree) dust grid
      5. A tree dust grid derived from a set of particles
      6. A Voronoi dust grid
      7. A dust grid based on the adaptive mesh dust geometry
 ? Enter one of these numbers [1,7] (3): 7
   ...
\endverbatim

<tt>SKIRT</tt> discretizes the dust on a grid structure, i.e. a collection of small cells in which properties such as
dust density and temperature are considered to be uniform. You could select any of the 3D dust grids offered by
<tt>SKIRT</tt>. The octtree grid, for example, builds a grid adapted to the dust density distribution based on some
given parameters. When importing a dust distribution from an adaptive mesh data file, <tt>SKIRT</tt> also offers the
option to directly use the adaptive mesh (defined by the data file) as a dust grid. The dust grid then exactly mirrors
the resolution structure of the hydrodynamical simulation, which seems a natural thing to do. On the other hand, in
some cases building a new grid (perhaps with less cells) may prove meaningful. Indeed, the hydrodynamical simulation
and the radiative transfer post-processing might have different resolution requirements. Regridding may help to place
smaller cells in regions where it matters for radiaton transport, and/or to reduce the runtime of the <tt>SKIRT</tt>
simulation.

For this tutorial select the option to use the imported adaptive mesh as a dust grid.

The dust system takes a few additional parameters which can be left to their default value (not shown).

\section TutorialHydroAmrInst Instrument system

\verbatim
   ...
   Possible choices for item #1 in the instruments list:
      1. A basic instrument that outputs the total integrated flux as an SED
      2. A basic instrument that outputs the total flux in every pixel as a data cube
      3. A basic instrument that outputs the total flux as data cube and as SED
      4. An advanced instrument that records individual contributions to the flux
         ...
 ? Enter one of these numbers or zero to terminate the list [0,5] (3): 4
 ? Enter the name for this instrument: xy
 ? Enter the distance to the system ]0 pc,.. pc[: 1 pc
 ? Enter the inclination angle of the detector [0 deg,180 deg] (0 deg):
 ? Enter the azimuth angle of the detector [-360 deg,360 deg] (0 deg):
 ? Enter the position angle of the detector [-360 deg,360 deg] (0 deg): 90
 ? Enter the total field of view in the horizontal direction ]0 AU,.. AU[: 0.06e18 cm
 ? Enter the number of pixels in the horizontal direction [1,10000] (250): 400
 ? Enter the center of the frame in the horizontal direction ]-.. AU,.. AU[ (0 AU):
 ? Enter the total field of view in the vertical direction ]0 AU,.. AU[: 0.06e18 cm
 ? Enter the number of pixels in the vertical direction [1,10000] (250): 400
 ? Enter the center of the frame in the vertical direction ]-.. AU,.. AU[ (0 AU):
 ? Enter the number of scattering levels to be recorded individually [0,100] (0):
   Possible choices for item #2 in the instruments list:
      1. A basic instrument that outputs the total integrated flux as an SED
         ...
 ? Enter one of these numbers or zero to terminate the list [0,5] (3): 0
\endverbatim

Since you want to study the scattered light separately, you need to select the advanced instrument that records
individual contributions to the flux. Position the instrument so that it shows a projection of the \f$xy\f$ coordinate
plane (angles: 0, 0, 90 degrees). This facilitates visual comparison of the recorded fluxes with the corresponding cut
through the dust density automatically produced by <tt>SKIRT</tt>. The distance of the instrument to the model affects
all fluxes with the same factor; use a value of your liking (for example 1 pc). Setup a pixel resolution of your liking
(for example \f$400\times400\f$ pixels) and provide a field of view that matches the size of the dust distribution to
be imported. For the AMR file used in this tutorial, the size of the cubical dust distribution in each direction is
\f$0.06\times10^{18}\f$ cm.

Leave the number of photon packages at the default value of \f$10^{6}\f$ (not shown).

\section TutorialHydroAmrRun Running the simulation

After all questions have been answered, <tt>SKIRT</tt> writes out the resulting ski file and terminates. Start
<tt>SKIRT</tt> again, this time specifying the name of the new \em ski file on the command line, to actually perform
the simulation. If the input data file \c kh_amr.dat is not in your current directory, you can specify the input
directory on the <tt>SKIRT</tt> command line. For example:

\verbatim
skirt -i ../in ScatAMR
\endverbatim

\section TutorialHydroAmrOutput Output files

Most of the output files for this tutorial are similar to those already described for the "Monochromatic simulation
of a dusty disk galaxy" tutorial. This section describes the output file types that are new to this tutorial.

Because the geometry in this simulation is truly three-dimensional (i.e. it has no axial or spherical symmetries),
there are now three cuts through the dust density (one along each of the coordinate planes) rather than two. Also, the
advanced instrument used in this tutorial produces multiple files. First, \c ScatAMR_xy_sed.dat is a short text data
file that lists the integrated fluxes observed by the instrument for each wavelength in the simulation's wavelength
grid. Because there are only three wavelengths for this simulation, this "SED" is not particularly interesting.

More importantly, the instrument records several components of the observed surface brightness in separate data cubes
(each including three frames, i.e one for each wavelength):

 - \c ScatAMR_xy_total.fits contains the total surface brightness detected by the instrument
   (i.e. the sum of the direct, scattered and dust flux).
 - \c ScatAMR_xy_direct.fits contains the surface brightness resulting from stellar photon packages
   that directly reach the instrument without being scattered.
 - \c ScatAMR_xy_scattered.fits contains the surface brightness resulting from stellar photon
   packages that were scattered by the dust before reaching the instrument.
 - \c ScatAMR_xy_transparent.fits contains the surface brightness that would be detected
   by the instrument if there were no dust in the system.

\section TutorialHydroAmrRes Interpreting simulation results

It is always a good idea to open \c ScatAMR_ds_convergence.dat in a text editor and check the dust grid convergence
metrics. For this simulation, the expected values are identical to the actual values (within numerical rounding errors)
because the radiative transfer grid is identical to the grid on which the input dust density is represented. It is also
instructive to compare some of the theoretical and gridded dust density cuts (e.g. \c ScatAMR_ds_trhoxy.fits versus
\c ScatAMR_ds_grhoxy.fits) in a FITS viewer such as DS9. Again, in this simulation, both are identical for the same
reason.

The transparent surface brightness (\c ScatAMR_xy_transparent.fits) simply reflects the Plummer model used as a
radiation source. It would be the same for all three wavelengths, if not for the noise caused by the Monte Carlo
technique used in <tt>SKIRT</tt>, especially given the small number of photon packages used for this simulation.

The total surface brightness (\c ScatAMR_xy_total.fits) shows the effects of wavelength-dependent dust extinction, but
is still dominated by direct light from the Plummer source. Interestingly, <tt>SKIRT</tt> allows you to single out the
radiation that gets observed after having been scattered by the dust at least once. The scattered surface brightness
(\c ScatAMR_xy_scattered.fits) indeed shows a marked pattern that is very similar to the geometry of the dust
distribution in the \f$xy\f$ plane.

\section TutorialHydroAmrRGB Making RGB images

<tt>PTS</tt> offers a command to create a regular RGB image (in PNG format) for the "total" FITS files generated by
<tt>SKIRT</tt> instruments. By default <tt>PTS</tt> uses the first FITS frame for the Blue channel, the last FITS frame
for the Red channel, and some frame in the middle for the Green channel. This works well for monochromatic simulations
such as this tutorial simulation (producing a grayscale image) and for oligochromatic simulations with 3 wavelengths
such as the one in this tutorial.

Unfortunately the "total" part of the filename is hardcoded in this PTS function. Getting an RGB image for the
scattered surface brightness requires a bit of a hack, i.e. temporarily renaming the relevant files. After the
simulation has completed, make sure that the <tt>SKIRT</tt> output directory is your current directory, and enter the
following commands (or perform the equivalent moves and copies in a file manager):

\verbatim
$ pts makergb
   ...
$ mv ScatAMR_xy_total.png TEMP_ScatAMR_xy_total.png
$ mv ScatAMR_xy_total.fits TEMP_ScatAMR_xy_total.fits
$ cp ScatAMR_xy_scattered.fits ScatAMR_xy_total.fits
$ pts makergb
   ...
$ mv ScatAMR_xy_total.png ScatAMR_xy_scattered.png
$ mv TEMP_ScatAMR_xy_total.png ScatAMR_xy_total.png
$ mv TEMP_ScatAMR_xy_total.fits ScatAMR_xy_total.fits
\endverbatim

The image files (in PNG format) are placed next to the original data files using the same name except for the .png
extension. The colors in the images are caused by the surface brightness differences for the three wavelengths,
including the "physical" differences in addition to the Monte Carlo noise in the <tt>SKIRT</tt> results.
The latter effect is quite severe because of the small number of photon packages in this tutorial simulation.


<b><i>Congratulations, you made it to the end of this tutorial!</i></b>

*/
