/**

\page UserTut3 Tutorial 3: Scattering from dust in a Kelvin-Helmholtz instability

\image html TutorialScatAMR.png
\image latex TutorialScatAMR.png

In this tutorial you will use <tt>SKIRT</tt> to study the dust in a Kelvin-Helmholtz instability as it might occur in
a molecular cloud. The dust distribution has been generated by a hydrodynamical simulation on an adaptive mesh
(AMR = Adaptive Mesh Refinement) with the MPI-AMRVAC code developed at the K.U.Leuven
(see <a href="http://homes.esat.kuleuven.be/~keppens">http://homes.esat.kuleuven.be/~keppens</a>).
The simulation includes a gas component and two dust components with different characteristics.
The simulation results are stored as a single data file in a binary format specific to MPI-AMRVAC.
In addition to a more generic AMR import format using text columns, <tt>SKIRT</tt> can also directly import
the MPI-AMRVAC binary format.

\section UserTut3Pre Getting ready

Before starting this tutorial, you should have installed and/or built the <tt>SKIRT</tt> code as described in the
\ref InstallationGuide, \em and you should have completed \ref UserTut1.
A lot of information provided in the first tutorial is not repeated here!

To complete this tutorial, you need the output file produced by the MPI-AMRVAC simulation.
Download the file \c kh_amr.dat from the <a href="http://www.skirt.ugent.be/downloads">SKIRT downloads page</a>
and put it into your \c ~/SKIRT/run directory.

\section UserTut3Ski Creating the ski file

In a Terminal window, with an appropriate current directory, start
<tt>SKIRT</tt> without any command line arguments. <tt>SKIRT</tt> responds with a welcome
message and starts an interactive session in the terminal window,
during which it will prompt you for all the information describing
a particular simulation:

\verbatim
   Welcome to SKIRT v___
   Interactively constructing a simulation...
 ? Enter the name of the ski file to be created: ScatAMR
\endverbatim

The first question is for the filename of the \em ski file. For this tutorial, enter "ScatAMR".

\section UserTut3Sim Type of simulation

\verbatim
   Possible choices for the simulation:
      1. An oligochromatic Monte Carlo simulation
      2. A panchromatic Monte Carlo simulation
 ? Enter one of these numbers [1,2] (1): 1
\endverbatim

In an actual research setting you would probably run a panchromatic
simulation to study the absorption, scattering and thermal emission
by the dust over a range of wavelengths. In this tutorial you will
simply study scattering by the dust at a single V-band wavelength.
An oligochromatic simulation is sufficient and most performance-effective
for these purposes.

Leave the parameters related to the random generator to their default
values (not shown).

\section UserTut3Uni Units

\verbatim
   Possible choices for the units system:
      1. SI units
      2. Stellar units (length in AU, distance in pc)
      3. Extragalactic units (length in pc, distance in Mpc)
 ? Enter one of these numbers [1,3] (3): 2
\endverbatim

The spatial scale of the dust distribution used in this tutorial is
such that it seems best to select stellar units. While you can still
use any of the supported units to enter parameter values, this means
that all output values will be presented in stellar units.

\section UserTut3Inst Instrument system

\verbatim
   Possible choices for the instrument system:
      1. An instrument system
   Automatically selected the only choice: 1
   Possible choices for item #1 in the instruments list:
      1. A basic instrument that outputs the total integrated flux as an SED
      2. A basic instrument that outputs the total flux in every pixel as a data cube
      3. A basic instrument that outputs the total flux as data cube and as SED
      4. An advanced instrument that records individual contributions to the flux
         ...
 ? Enter one of these numbers or zero to terminate the list [0,6] (3): 4
 ? Enter the name for this instrument: xy
 ? Enter the distance to the system [0 pc,.. pc]: 1
 ? Enter the inclination angle of the detector [0 deg,180 deg] (0 deg):
 ? Enter the azimuth angle of the detector [-360 deg,360 deg] (0 deg):
 ? Enter the position angle of the detector [-360 deg,360 deg] (0 deg): 90
 ? Enter the number of pixels in the horizontal direction [25,10000] (250): 500
 ? Enter the maximal horizontal extent [0 AU,.. AU]: 0.0315421e18 cm
 ? Enter the number of pixels in the vertical direction [25,10000] (250): 500
 ? Enter the maximal vertical extent [0 AU,.. AU]: 0.03e18 cm
 ? Enter the number of scattering levels to be recorded individually [0,25] (0):
   Possible choices for item #2 in the instruments list:
      1. A basic instrument that outputs the total integrated flux as an SED
         ...
 ? Enter one of these numbers or zero to terminate the list [0,6] (3): 0
\endverbatim

Since you want to study the scattered light separately, you need to
select the advanced instrument that records individual contributions
to the flux. Position the instrument so that it shows a projection
of the \f$xy\f$ coordinate plane (angles: \f$0,0,90\f$). This facilitates
visual comparison of the recorded fluxes with the corresponding cut
through the dust density automatically produced by SKIRT. The distance
of the instrument to the model affects all fluxes with the same factor;
use a value of your liking (for example 1 pc). Setup a pixel resolution
of your liking (for example \f$500\times500\f$ pixels) and provide a
frame extent that matches the extent of the dust distribution to be
imported. This information is not included in the AMR data file, so
it should be passed along separately.

\note A <tt>SKIRT</tt> instrument frame is a rectangle centered on the
origin and an imported AMR dust distribution is a cuboid centered
on the origin. In both cases the extent specifies half the total size
along one of the coordinate axes.

For the AMR file used in this tutorial, the dust distribution has
extent \f$(0.0315421,0.03,0.03)\f$ in units of \f$10^{18}\f$ cm. Since <tt>SKIRT</tt>
understands centimetres, there is no need for manual conversion of these
values.

Leave the number of photon packages to the default value of \f$10^{6}\f$
(not shown).

\section UserTut3Wave Wavelength grid

\verbatim
   Possible choices for the wavelength grid:
      1. A list of one or more distinct wavelengths
   Automatically selected the only choice: 1
 ? Enter the wavelengths [0.0001 micron,1e6 micron]: 0.55
\endverbatim

For this tutorial enter a wavelength list
containing the single value \f$\lambda=0.55\,\mu\textrm{m}\f$ (V-band).

\section UserTut3Stel Stellar system

\verbatim
   Possible choices for the stellar system:
      1. A stellar system
   Automatically selected the only choice: 1
   Possible choices for item #1 in the stellar components list:
      1. A stellar component with a built-in geometry (in an oligochromatic simulation)
      2. A stellar component derived from an SPH output file
      3. A stellar component imported from an adaptive mesh data file
      4. A stellar component imported from a Voronoi mesh data file
 ? Enter one of these numbers [1,4] (1): 1
   Possible choices for the geometry of the stellar distribution:
      1. A point source geometry
      2. A Plummer geometry
      3. A gamma geometry
         ...
 ? Enter one of these numbers [1,23] (1): 2
 ? Enter the scale length [0 AU,.. AU]: 0.03e18 cm
 ? Enter the luminosities, one for each wavelength, in solar units [0,..]: 1e-6
   Possible choices for item #2 in the stellar components list:
      1. A stellar component with a built-in geometry (in an panchromatic simulation)
         ...
 ? Enter one of these numbers or zero to terminate the list [0,1] (1): 0
\endverbatim

Since the data file provided for this tutorial has no information
on light sources, you need to provide an artificial stellar system
to illuminate the dust. The suggested option is to use a Plummer profile
with a scale length comparable to the size of the dust distribution;
this creates a fairly constant source of light across the configuration
space. Specify a total luminosity consistent with an artificial background
source, for example \f$10^{-6}\f$ solar luminosities.

\section UserTut3Dust Dust system

\verbatim
   Possible choices for the dust system:
      1. A dust system for use with oligochromatic simulations
 ? Enter one of these numbers or zero to select none [0,1] (1): 1
   Possible choices for the dust distribution:
      1. A dust distribution composed of various dust components
      2. A dust distribution derived from an SPH output file
      3. A dust distribution imported from an adaptive mesh data file
      4. A dust distribution imported from a Voronoi mesh data file
 ? Enter one of these numbers [1,4] (1): 3
   Possible choices for the adaptive mesh data file:
      1. An adaptive mesh data file in ASCII format
      2. An adaptive mesh data file in MPI-AMRVAC format
 ? Enter one of these numbers [1,2] (1): 2
 ? Enter the name of the adaptive mesh data file: kh_amr.dat
 ? Enter the number of mesh cells at the coarsest level, in the X direction [1,10000]: 32
 ? Enter the number of mesh cells at the coarsest level, in the Y direction [1,10000]: 128
 ? Enter the number of mesh cells at the coarsest level, in the Z direction [1,10000]: 32
 ? Enter the units for the density values [0 Msun/AU3,.. Msun/AU3]: 1e-21 g/cm3
 ? Enter the outer radius of the domain in the x direction [0 AU,.. AU]: 0.0315421e18 cm
 ? Enter the outer radius of the domain in the y direction [0 AU,.. AU]: 0.03e18 cm
 ? Enter the outer radius of the domain in the z direction [0 AU,.. AU]: 0.03e18 cm
\endverbatim

For this tutorial, select an oligochromatic dust system (the only
applicable type with an oligochromatic simulation) with a dust distribution
imported from an adaptive mesh data file.

Select the MPI-AMRVAC format and enter the appropriate filename (kh_amr.dat).
You must also provide some information that is not included in the
AMR data file: the number of mesh cells at the coarsest mesh level
in each direction; the spatial extent of the mesh in each direction;
and the units of the density values stored in the file.

For the data file used in this tutorial, the number of mesh cells
at the coarsest level is \f$(32,128,32)\f$, the dust distribution has
extent \f$(0.0315421,0.03,0.03)\f$ in units of \f$10^{18}\f$ cm, and the
density values in the file are given in units of \f$10^{-21}\,\mathrm{g}\,\mathrm{cm^{-3}}\f$.
Since <tt>SKIRT</tt> understands these units, there is no need for manual conversion.

Now you need to configure the dust components for which the data file
defines a density distribution:

\verbatim
   Possible choices for item #1 in the dust components list:
      1. An mesh dust component
   Automatically selected the only choice: 1
 ? Enter the column defining the density distribution [0,99] (0): 5
 ? Enter the column defining an extra multiplication factor, or -1 [-1,99] (-1):
 ? Enter the fraction of the density actually locked up in dust grains [0,1] (1):
   Possible choices for the dust mixture for the dust component:
      1. A Draine & Li (2007) dust mix
      2. A dust mix with average interstellar properties
         ...
 ? Enter one of these numbers [1,9] (2):
 ? Output the optical properties of the dust mix? [yes/no] (yes): no
 ? Output the mean optical properties of the dust mix? [yes/no] (yes): no

   Possible choices for item #2 in the dust components list:
      1. An mesh dust component
 ? Enter one of these numbers or zero to terminate the list [0,1] (1): 1
 ? Enter the column defining the density distribution [0,99] (0): 6
 ? Enter the column defining an extra multiplication factor, or -1 [-1,99] (-1):
 ? Enter the fraction of the density actually locked up in dust grains [0,1] (1):
   Possible choices for the dust mixture for the dust component:
      1. A Draine & Li (2007) dust mix
      2. A dust mix with average interstellar properties
      ...
 ? Enter one of these numbers [1,9] (2):
 ? Output the optical properties of the dust mix? [yes/no] (yes): no
 ? Output the mean optical properties of the dust mix? [yes/no] (yes): no

   Possible choices for item #3 in the dust components list:
      1. An mesh dust component
 ? Enter one of these numbers or zero to terminate the list [0,1] (1): 0
\endverbatim

The file contains two dust density distributions given respectively
by the variables (or columns) with index 5 and 6. There is no extra
multiplication factor or fraction, so you can leave these parameters
to their default value. The dust mix (which defines the characteristics
of the dust grains) is automatically selected since for an oligochromatic
simulation there is only one choice. For a panchromatic simulation
you would be able to specify different characteristics for each dust
component.

\verbatim
   Possible choices for the dust grid structure:
      1. A 3D cartesian grid structure with a linear distribution
      2. A 3D cartesian grid structure with a power-law distribution
      3. A 3D dust grid structure with a two-phase medium
      4. An octtree dust grid structure
      5. A k-d tree (binary tree) dust grid structure
      6. A tree dust grid structure derived from a set of particles
      7. A Voronoi dust grid structure
      8. A dust grid structure based on the adaptive mesh dust geometry
 ? Enter one of these numbers [1,8] (4): 8
\endverbatim

SKIRT discretizes the dust on a grid structure, i.e. a collection
of small cells in which properties such as dust density and temperature
are considered to be uniform. You could select any of the 3D dust
grids offered by SKIRT. The octtree grid for example builds a grid
adapted to the dust density distribution based on some given parameters.
When importing a dust distribution from an adaptive mesh data file,
SKIRT also offers the option to directly use the adaptive mesh (defined
by the data file) as a dust grid. The dust grid then exactly mirrors
the resolution structure of the hydrodynamical simulation, which seems
a natural thing to do. On the other hand, in some cases building a
new grid (perhaps with less cells) may prove meaningful to reduce
the runtime of the <tt>SKIRT</tt> simulation.

For this tutorial select the option to use the imported adaptive mesh
as a dust grid.

Finally the dust system takes a few additional parameters which can
be left to their default value (not shown).

\section UserTut3Run Running the simulation

After all questions have been answered, <tt>SKIRT</tt> writes out the resulting
ski file and terminates. Start <tt>SKIRT</tt> again, this time specifying the
name of the new \em ski file on the command line, to actually perform the
simulation.

\section UserTut3Output Output files

Most of the output files have already been described for one of the
previous tutorials. The instrument used in this tutorial does produce
some additional files to record individual flux components:

 - \c ScatAMR_total.fits contains the total flux detected by the instrument
   (i.e. the sum of the direct, scattered and dust flux).
 - \c ScatAMR_direct.fits contains the flux resulting from stellar photon packages
   that directly reach the instrument without being scattered.
 - \c ScatAMR_scattered.fits contains the flux resulting from stellar photon
   packages that were scattered by the dust before reaching the instrument.
 - \c ScatAMR_dust.fits contains the flux resulting from photon packages that
   were emitted by the dust; for oligochromatic simulations (no thermal
   dust emission) this flux component is zero.
 - \c ScatAMR_transparent.fits contains the total flux that would be detected
   by the instrument if there were no dust in the system.

\section UserTut3Verif Verifying results

The file \c ScatAMR_ds_trhoxy.fits shows a cut through the total dust
density along the \f$xy\f$ coordinate plane. It should resemble the left
panel of the illustration at the beginning of this tutorial.

The file \c ScatAMR_xy_scattered.fits shows the flux resulting from
photon packages that were scattered by the dust (i.e. excluding any
photon packages that reach the instrument without being scattered).
It should resemble the right panel of the illustration at the beginning
of this tutorial.

*/
